<nav aria-label="Main navigation" class="relative">
  <button
    id="mobile-menu-button"
    class="rounded-full p-2 transition-all duration-300 hover:bg-foreground/10 md:hidden"
    aria-label="Toggle menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        id="hamburger-top"
        class="origin-center transition-all duration-300"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 6h16"></path>
      <path
        id="hamburger-middle"
        class="transition-all duration-300"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 12h16"></path>
      <path
        id="hamburger-bottom"
        class="origin-center transition-all duration-300"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 18h16"></path>
    </svg>
  </button>

  <ul class="hidden gap-2 rounded-full px-2.5 py-0.5 md:flex lg:gap-3 lg:px-4">
    <li>
      <a
        href="/about/"
        class="nav-link flex min-h-[44px] items-center rounded-full px-2 py-1 text-sm font-normal text-foreground transition hover:bg-foreground/10 hover:shadow-inner lg:px-2.5"
        >About</a
      >
    </li>
    <li>
      <a
        href="/projects/"
        class="nav-link flex min-h-[44px] items-center rounded-full px-2 py-1 text-sm font-normal text-foreground transition hover:bg-foreground/10 hover:shadow-inner lg:px-2.5"
        >Projects</a
      >
    </li>
    <li>
      <a
        href="/cv/"
        class="nav-link flex min-h-[44px] items-center rounded-full px-2 py-1 text-sm font-normal text-foreground transition hover:bg-foreground/10 hover:shadow-inner lg:px-2.5"
        >CV</a
      >
    </li>
  </ul>

  <div
    id="mobile-backdrop"
    class="pointer-events-none fixed inset-0 -z-10 bg-black/20 opacity-0 backdrop-blur-sm transition-opacity duration-200 md:hidden"
    aria-hidden="true"
  >
  </div>

  <div
    id="mobile-menu"
    class="pointer-events-none absolute right-0 top-full mt-2 min-w-[12rem] origin-top-right scale-95 rounded-lg border bg-background/95 opacity-0 shadow-lg backdrop-blur-md transition-all duration-200 md:hidden"
  >
    <ul class="space-y-1 p-2">
      <li>
        <a
          href="/about/"
          class="nav-link-mobile block flex min-h-[44px] items-center rounded-lg px-3 py-2 text-sm font-normal text-foreground transition-all duration-150 hover:scale-[1.02] hover:bg-foreground/10"
          >About</a
        >
      </li>
      <li>
        <a
          href="/projects/"
          class="nav-link-mobile block flex min-h-[44px] items-center rounded-lg px-3 py-2 text-sm font-normal text-foreground transition-all duration-150 hover:scale-[1.02] hover:bg-foreground/10"
          >Projects</a
        >
      </li>
      <li>
        <a
          href="/cv/"
          class="nav-link-mobile block flex min-h-[44px] items-center rounded-lg px-3 py-2 text-sm font-normal text-foreground transition-all duration-150 hover:scale-[1.02] hover:bg-foreground/10"
          >CV</a
        >
      </li>
    </ul>
  </div>
</nav>

<script>
  function updateActiveNav() {
    const navLinks = document.querySelectorAll('.nav-link, .nav-link-mobile');
    const currentPath = window.location.pathname;

    navLinks.forEach((link) => {
      if (link instanceof HTMLAnchorElement) {
        if (link.getAttribute('href') === currentPath) {
          link.setAttribute('aria-current', 'page');
          link.classList.add('bg-foreground/10', 'shadow-inner');
        } else {
          link.removeAttribute('aria-current');
          link.classList.remove('bg-foreground/10', 'shadow-inner');
        }
      }
    });
  }

  function animateHamburger(isOpen: boolean) {
    const topLine = document.getElementById('hamburger-top');
    const middleLine = document.getElementById('hamburger-middle');
    const bottomLine = document.getElementById('hamburger-bottom');

    if (!topLine || !middleLine || !bottomLine) return;

    if (isOpen) {
      topLine.setAttribute('d', 'M6 6L18 18');
      middleLine.setAttribute('d', 'M12 12h0');
      middleLine.style.opacity = '0';
      bottomLine.setAttribute('d', 'M6 18L18 6');
    } else {
      topLine.setAttribute('d', 'M4 6h16');
      middleLine.setAttribute('d', 'M4 12h16');
      middleLine.style.opacity = '1';
      bottomLine.setAttribute('d', 'M4 18h16');
    }
  }

  function setupMobileMenu() {
    const menuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const backdrop = document.getElementById('mobile-backdrop');

    if (!menuButton || !mobileMenu || !backdrop) return;

    function openMenu() {
      menuButton.setAttribute('aria-expanded', 'true');
      mobileMenu.classList.remove(
        'opacity-0',
        'scale-95',
        'pointer-events-none'
      );
      mobileMenu.classList.add('opacity-100', 'scale-100');
      backdrop.classList.remove('opacity-0', 'pointer-events-none');
      backdrop.classList.add('opacity-100');
      animateHamburger(true);
    }

    function closeMenu() {
      menuButton.setAttribute('aria-expanded', 'false');
      mobileMenu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
      mobileMenu.classList.remove('opacity-100', 'scale-100');
      backdrop.classList.add('opacity-0', 'pointer-events-none');
      backdrop.classList.remove('opacity-100');
      animateHamburger(false);
    }

    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    backdrop.addEventListener('click', () => {
      closeMenu();
    });

    document.addEventListener('click', (e) => {
      if (!mobileMenu.contains(e.target as Node) && e.target !== menuButton) {
        closeMenu();
      }
    });

    const mobileLinks = mobileMenu.querySelectorAll('.nav-link-mobile');
    mobileLinks.forEach((link) => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });

    document.addEventListener('keydown', (e) => {
      if (
        e.key === 'Escape' &&
        menuButton.getAttribute('aria-expanded') === 'true'
      ) {
        closeMenu();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateActiveNav();
    setupMobileMenu();
  });

  // For client-side routing if used in future
  document.addEventListener('astro:page-load', () => {
    updateActiveNav();
    setupMobileMenu();
  });
</script>
